<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Réserver une table</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
</head>
<body>
<div id="notification" class="notification hidden">
  <p id="notification-message"></p>
  <button class="close-btn" onclick="hideNotification()">×</button>
</div>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">Réservation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="user.html">Profil</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
      <button id="auth-button"></button>
    </div>
    <div id="user-status"></div>
  </nav>
</header>
<h1 class="title-book">Réserver une table</h1>
<section id="reservation-section">
  <form id="reservation-form">
    <label for="adresse">Votre adresse mail :</label>
    <input type="email" name="adresse" id="adresse" required placeholder="exemple@exemple.Com">

    <label>Numéro de téléphone :</label>
    <input type="tel" name="telephone" id="telephone" required pattern="^0[1-9][0-9]{8}$" placeholder="06XXXXXXXX">

    <label for="couverts">Nombre de couverts :</label>
    <input type="number" name="couverts" id="couverts" min="1" max="20" required placeholder="max 20, pour plus, veuillez nous contacter">

    <label for="date">Date :</label>
    <input type="date" name="date" id="date" required>

    <label for="heure">Heure :</label>
    <input type="time" name="heure" id="heure" required>
    <p id="opening-hours-info" class="horaires-info"></p>

    <label for="commentaire">Commentaire :</label>
    <textarea name="commentaire" id="commentaire" rows="4" cols="50" maxlength="500"></textarea>

    <input type="text" name="company" id="company" style="display: none;">

    <button type="submit">Réserver</button>
    <button type="button" id="reset-button">Vider le formulaire</button>
    <p class="avertissement">Les données de ce formulaires ne sont utilisé que dans le but de traiter votre demande. En cas d'annulation ou de modification, merci de nous prévenir au  04 68 12 34 56.</p>
  </form>
</section>
<footer>
  <div class="footer-logo">
    <img src="public/logo.png" alt="Logo Chez Mario">
  </div>
  <div class="footer-infos">
    <p>Chez Mario <span class="sep">|</span> 12 Rue des Oliviers, 66000 Perpignan <span class="sep">|</span> 04 68 12 34 56 <span class="sep">|</span> email: contact@chezmario.fr</p>
  </div>
  <div class="footer-credit">
    <p>Réalisation : GD</p>
  </div>
  <div class="footer-map">
    <a href="https://www.google.com/maps/place/12+Rue+des+Oliviers,+66000+Perpignan" target="_blank" class="map-button">Plan d'accès</a>
  </div>
</footer>
<script src="script.js"></script>
<script>
let horairesOuverture = {};

// Fonction pour simuler les horaires (remplacez par votre appel API)
function loadHoraires() {
  return new Promise((resolve) => {
    // Simulation des horaires - remplacez par votre appel API réel
    horairesOuverture = {
      "Dimanche": "Fermé",
      "Lundi": "11h30 - 14h00 / 18h30 - 22h00",
      "Mardi": "11h30 - 14h00 / 18h30 - 22h00",
      "Mercredi": "11h30 - 14h00 / 18h30 - 22h00",
      "Jeudi": "11h30 - 14h00 / 18h30 - 22h00",
      "Vendredi": "11h30 - 14h00 / 18h30 - 22h00",
      "Samedi": "11h30 - 14h00 / 18h30 - 22h00"
    };
    resolve();
  });
}

// Charger les horaires d'ouverture au chargement de la page
document.addEventListener('DOMContentLoaded', async () => {
  await loadHoraires();
  console.log("Horaires chargés :", horairesOuverture);
  updateHorairesInfo();
  autoFillUserEmail();
  updateReservationSubmission();
});

// Fonction pour convertir l'heure au format HH:MM
function parseTimeString(timeStr) {
  if (!timeStr) return null;
  const match = timeStr.match(/^(\d{1,2})h(\d{2})$/);
  if (match) {
    const [, hours, minutes] = match;
    return `${hours.padStart(2, '0')}:${minutes}`;
  }
  return null;
}

// Fonction pour obtenir le nom du jour en français - CORRIGÉE
function getDayName(dateString) {
  const jours = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
  
  // Création d'une date sans problème de fuseau horaire
  const [year, month, day] = dateString.split('-').map(Number);
  const date = new Date(year, month - 1, day); // month - 1 car les mois sont indexés à partir de 0
  
  return jours[date.getDay()];
}

// Fonction pour analyser les horaires d'un jour
function parseHoraires(horaireStr) {
  if (!horaireStr || horaireStr === "Fermé") {
    return null;
  }

  const periods = [];
  
  // Gérer les horaires avec ou sans pause déjeuner
  if (horaireStr.includes('/')) {
    // Format: "11h30-14h00/18h30-22h00"
    const parts = horaireStr.split('/');
    for (const part of parts) {
      const times = part.trim().split('-');
      if (times.length === 2) {
        const start = parseTimeString(times[0].trim());
        const end = parseTimeString(times[1].trim());
        if (start && end) {
          periods.push({ start, end });
        }
      }
    }
  } else {
    // Format simple: "11h30-22h00"
    const times = horaireStr.split('-');
    if (times.length === 2) {
      const start = parseTimeString(times[0].trim());
      const end = parseTimeString(times[1].trim());
      if (start && end) {
        periods.push({ start, end });
      }
    }
  }
  
  return periods.length > 0 ? periods : null;
}

// Fonction pour vérifier si une heure est dans les horaires d'ouverture
function isTimeInOpeningHours(selectedDate, selectedTime) {
  const dayName = getDayName(selectedDate);
  const horaireJour = horairesOuverture[dayName];
  
  if (!horaireJour || horaireJour === "Fermé") {
    return { valid: false, message: `Le restaurant est fermé le ${dayName.toLowerCase()}.` };
  }

  const periods = parseHoraires(horaireJour);
  if (!periods) {
    return { valid: false, message: `Horaires non disponibles pour le ${dayName.toLowerCase()}.` };
  }

  // Vérifier si l'heure sélectionnée est dans une des périodes d'ouverture
  for (const period of periods) {
    if (selectedTime >= period.start && selectedTime <= period.end) {
      return { valid: true };
    }
  }

  // Construire le message d'erreur avec les horaires disponibles
  const horaireDisplay = periods.map(p => `${p.start.replace(':', 'h')}-${p.end.replace(':', 'h')}`).join(' / ');
  return { 
    valid: false, 
    message: `L'heure sélectionnée n'est pas dans les horaires d'ouverture du ${dayName.toLowerCase()} (${horaireDisplay}).` 
  };
}

// Fonction pour mettre à jour l'affichage des horaires - CORRIGÉE
function updateHorairesInfo() {
  const dateInput = document.getElementById('date');
  const horaireInfo = document.getElementById('opening-hours-info');
  
  console.log('updateHorairesInfo appelée, dateInput.value:', dateInput.value);
  
  if (!dateInput.value) {
    horaireInfo.textContent = 'Sélectionnez une date pour voir les horaires d\'ouverture.';
    horaireInfo.style.color = '#666';
    return;
  }

  // Utiliser directement la valeur de la date (format YYYY-MM-DD)
  const dayName = getDayName(dateInput.value);
  const horaireJour = horairesOuverture[dayName];
  
  console.log('Jour sélectionné:', dayName, 'Horaires:', horaireJour);
  
  if (!horaireJour || horaireJour === "Fermé") {
    horaireInfo.textContent = `Le restaurant est fermé le ${dayName.toLowerCase()}.`;
    horaireInfo.style.color = '#d32f2f';
  } else {
    horaireInfo.textContent = `Horaires d'ouverture le ${dayName.toLowerCase()} : ${horaireJour}`;
    horaireInfo.style.color = '#2e7d32';
  }
}

// Écouter les changements de date
document.getElementById('date').addEventListener('change', updateHorairesInfo);

// Fonction pour simuler showNotification (remplacez par votre fonction réelle)
function showNotification(message, type) {
  console.log(`[${type.toUpperCase()}] ${message}`);
  // Ici, ajoutez votre logique d'affichage de notification
}

document.getElementById("reservation-form").addEventListener("submit", function(e) {
  e.preventDefault();

  const lastSubmission = parseInt(localStorage.getItem("lastReservationTime"), 10);
  const nowTimestamp = Date.now();
  const spamTimeout = 10 * 1000; // 10 secondes

  if (lastSubmission && nowTimestamp - lastSubmission < spamTimeout) {
    const remainingTime = spamTimeout - (nowTimestamp - lastSubmission);
    const minutes = Math.floor(remainingTime / 60000);
    const seconds = Math.floor((remainingTime % 60000) / 1000);

    showNotification(
      `Veuillez attendre encore ${minutes} minute${minutes !== 1 ? "s" : ""} et ${seconds} seconde${seconds !== 1 ? "s" : ""} avant de réserver à nouveau.`,
      "info"
    );
    return;
  }

  const form = this;
  const formData = new FormData(form);
  const couverts = parseInt(formData.get("couverts"), 10);

  if (couverts > 20) {
    showNotification("Le nombre de couverts est limité à 20.", "error");
    return;
  }

  const selectedDate = formData.get("date");
  const selectedTime = formData.get("heure");

  if (!selectedDate || !selectedTime) {
    showNotification("Veuillez sélectionner une date et une heure.", "error");
    return;
  }

  const selectedDateTime = new Date(`${selectedDate}T${selectedTime}`);
  const now = new Date();
  const minReservationTime = new Date(now.getTime() + 2 * 60 * 60 * 1000); // +2h

  const todayDate = now.toISOString().split("T")[0];

  // Cas 1 : date entière dans le passé
  if (selectedDate < todayDate) {
    showNotification("La date sélectionnée est déjà passée.", "error");
    return;
  }

  // Cas 2 : aujourd'hui mais heure déjà passée
  if (selectedDate === todayDate && selectedDateTime < now) {
    showNotification("L'heure sélectionnée est déjà passée.", "error");
    return;
  }

  // Cas 3 : pas assez de préavis
  if (selectedDateTime < minReservationTime) {
    showNotification("Les réservations doivent être faites au moins 2 heures à l'avance.", "error");
    return;
  }

  // Cas 4 : Vérifier les horaires d'ouverture
  const timeValidation = isTimeInOpeningHours(selectedDate, selectedTime);
  if (!timeValidation.valid) {
    showNotification(timeValidation.message, "error");
    return;
  }

  // Tout est bon
  showNotification("Envoi en cours...", "info");

  const company = formData.get("company");
  if (company) {
    showNotification("Bot détecté (champ caché rempli).", "error");
    return;
  }

  // Simulation d'envoi (remplacez par votre appel API réel)
  console.log("Données à envoyer:", {
    email: formData.get("adresse"),
    telephone: formData.get("telephone"),
    couverts: parseInt(formData.get("couverts"), 10),
    date: formData.get("date"),
    heure: formData.get("heure"),
    commentaire: formData.get("commentaire")
  });
  
  setTimeout(() => {
    showNotification("Réservation confirmée !", "success");
    localStorage.setItem("lastReservationTime", Date.now().toString());
  }, 1000);
});

// Fonction pour auto-remplir l'email de l'utilisateur connecté (simulation)
async function autoFillUserEmail() {
  console.log('Auto-remplissage email simulé');
  // Remplacez par votre logique réelle
}

// Fonction pour mettre à jour la soumission de réservation (simulation)
function updateReservationSubmission() {
  console.log('Mise à jour soumission réservation simulée');
  // Votre logique existante
}

document.getElementById("reset-button").addEventListener("click", function () {
  const form = document.getElementById("reservation-form");
  form.reset();
  document.getElementById('opening-hours-info').textContent = 'Sélectionnez une date pour voir les horaires d\'ouverture.';
  document.getElementById('opening-hours-info').style.color = '#666';
  showNotification("Le formulaire a été vidé.", "info");
});
</script>

<style>
.horaires-info {
  font-size: 0.9em;
  margin-top: 5px;
  padding: 8px;
  border-radius: 4px;
  background-color: #f5f5f5;
  border-left: 4px solid #2196F3;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px;
  border-radius: 5px;
  color: white;
  z-index: 1000;
}

.notification.hidden {
  display: none;
}

.notification.info {
  background-color: #2196F3;
}

.notification.error {
  background-color: #f44336;
}

.notification.success {
  background-color: #4CAF50;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
  float: right;
  margin-left: 10px;
}
</style>
</body>
</html>