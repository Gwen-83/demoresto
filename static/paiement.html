<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Paiement</title>
  <script>
    const token = localStorage.getItem('token');
    const cart = JSON.parse(localStorage.getItem('cart'));

    if (!token || !cart || cart.length === 0) {
      // Redirection AVANT chargement de la page
      window.location.href = "panier.html?error=unauthorized";
    }
  </script>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TKH4D424FE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TKH4D424FE');
  </script>
  <!-- Hotjar Tracking Code for https://demoresto.onrender.com/ -->
  <script>
      (function(h,o,t,j,a,r){
          h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
          h._hjSettings={hjid:6421174,hjsv:6};
          a=o.getElementsByTagName('head')[0];
          r=o.createElement('script');r.async=1;
          r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
          a.appendChild(r);
      })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
</head>
<body>
  <div id="notification" class="notification hidden">
  <p id="notification-message"></p>
  <button class="close-btn" onclick="hideNotification()">×</button>
</div>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">Réservation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="user.html">Profil</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
    </div>
    <div id="user-status"></div>
  </nav>
</header>

<section class="order-summary">
  <h2 class="title-payment">Résumé de votre commande</h2>
  <table>
    <thead>
      <tr>
        <th>Produit</th>
        <th>Quantité</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="payment-summary-body"></tbody>
  </table>
  <!-- Section pourboire -->
  <div id="tip-section" style="margin: 20px 0;">
    <h3>Ajouter un pourboire ?</h3>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <button type="button" class="tip-btn" data-tip="5">+5%</button>
      <button type="button" class="tip-btn" data-tip="10">+10%</button>
      <button type="button" class="tip-btn" data-tip="20">+20%</button>
      <span>Ou montant personnalisé :</span>
      <input type="number" id="custom-tip" min="0" step="0.01" placeholder="€" style="width: 80px;">
      <button type="button" id="apply-custom-tip">OK</button>
      <button type="button" id="remove-tip" style="margin-left:10px;">Retirer le pourboire</button>
    </div>
    <div id="tip-info" style="margin-top: 8px; color: #2e7d32;"></div>
  </div>
  <h3 id="payment-total">Total : 0.00€</h3>
</section>

<section class="payment-method">
  <h2>Moyen de paiement</h2>
  <!-- Exemple de paiement fictif -->
  <p>Ce site est une version Démo. Aucune transaction réelle ne sera effectuée. Si vous souhaitez tester, utilisez la carte "4242 4242 4242 4242" avec n'importe quel date dans le futur et n'importe quel CVC. Vous allez etre redirigé vers Stripe en cliquant ci-dessous.</p>
  <button onclick="simulatePayment()">Payer maintenant</button>
</section>

<script>
function showNotification(message, type = "success") {
  const notif = document.getElementById('notification');
  const msg = document.getElementById('notification-message');
  if (!notif || !msg) return;
  msg.innerText = message;
  notif.classList.remove('hidden', 'success', 'error', 'info');
  notif.classList.add(type);
  setTimeout(() => {
    hideNotification();
  }, 4000);
}
function hideNotification() {
  const notif = document.getElementById('notification');
  if (notif) {
    notif.classList.add('hidden');
    notif.classList.remove('success', 'error', 'info');
  }
}

if (!token || !cart || cart.length === 0) {
  // Redirection AVANT chargement de la page
  window.location.href = "panier.html?error=unauthorized";
}

function getToken() {
  return localStorage.getItem('token');
}

// Ajout : gestion du pourboire
let tipValue = 0;
let tipType = null; // "percent" ou "fixed"
let tipPercent = 0;
let baseTotal = 0;
let deliveryFee = 0;

function saveTipToStorage() {
  localStorage.setItem('tip', JSON.stringify({type: tipType, value: tipValue, percent: tipPercent}));
}
function loadTipFromStorage() {
  const tip = localStorage.getItem('tip');
  if (tip) {
    try {
      const t = JSON.parse(tip);
      tipType = t.type;
      tipValue = t.value;
      tipPercent = t.percent || 0;
    } catch {}
  }
}
function clearTip() {
  tipType = null;
  tipValue = 0;
  tipPercent = 0;
  localStorage.removeItem('tip');
}

function updateTipInfo() {
  const info = document.getElementById('tip-info');
  if (!tipType) {
    info.textContent = '';
    return;
  }
  if (tipType === 'percent') {
    info.textContent = `Pourboire ajouté : ${tipPercent}% (${tipValue.toFixed(2)}€)`;
  } else if (tipType === 'fixed') {
    info.textContent = `Pourboire ajouté : ${tipValue.toFixed(2)}€`;
  }
}

function updatePaymentTotalDisplay() {
  let total = baseTotal;
  if (deliveryFee) total += deliveryFee;
  if (tipValue) total += tipValue;
  document.getElementById('payment-total').textContent = `Total : ${total.toFixed(2)}€`;
}

function loadPaymentDetails() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const orderData = JSON.parse(localStorage.getItem('orderData')) || {};
  const tbody = document.getElementById('payment-summary-body');
  const totalElement = document.getElementById('payment-total');
  tbody.innerHTML = '';
  baseTotal = 0;
  deliveryFee = 0;

  cart.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${item.product.name}</td>
        <td>${item.quantity}</td>
        <td>${(item.product.price * item.quantity).toFixed(2)}€</td>
    `;
    tbody.appendChild(row);
    baseTotal += item.product.price * item.quantity;
  });

  // Ajouter les frais de livraison si activés
  if (orderData.delivery) {
    const deliveryRow = document.createElement('tr');
    deliveryRow.innerHTML = `
      <td>Frais de livraison</td>
      <td>1</td>
      <td>5.00€</td>
    `;
    tbody.appendChild(deliveryRow);
    deliveryFee = 5.00;
  }

  // Charger le pourboire depuis le stockage
  loadTipFromStorage();
  // Recalcule le montant du pourboire si pourcentage
  if (tipType === 'percent') {
    tipValue = ((baseTotal + deliveryFee) * tipPercent / 100);
  }
  updateTipInfo();

  // Afficher la ligne pourboire si présent
  let tipRow = document.getElementById('tip-row');
  if (tipValue > 0) {
    if (!tipRow) {
      tipRow = document.createElement('tr');
      tipRow.id = 'tip-row';
      tbody.appendChild(tipRow);
    }
    tipRow.innerHTML = `
      <td>Pourboire</td>
      <td></td>
      <td>${tipValue.toFixed(2)}€</td>
    `;
  } else if (tipRow) {
    tipRow.remove();
  }

  updatePaymentTotalDisplay();
}

function handleTipButton(percent) {
  tipType = 'percent';
  tipPercent = percent;
  tipValue = ((baseTotal + deliveryFee) * percent / 100);
  saveTipToStorage();
  loadPaymentDetails();
}
function handleCustomTip() {
  const val = parseFloat(document.getElementById('custom-tip').value);
  if (isNaN(val) || val < 0) {
    alert("Montant invalide");
    return;
  }
  tipType = 'fixed';
  tipValue = val;
  tipPercent = 0;
  saveTipToStorage();
  loadPaymentDetails();
}
function handleRemoveTip() {
  clearTip();
  loadPaymentDetails();
}

document.addEventListener('DOMContentLoaded', function() {
  loadPaymentDetails();
  // Boutons pourboire
  document.querySelectorAll('.tip-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      handleTipButton(parseInt(this.dataset.tip));
    });
  });
  document.getElementById('apply-custom-tip').addEventListener('click', handleCustomTip);
  document.getElementById('remove-tip').addEventListener('click', handleRemoveTip);
});

window.onload = loadPaymentDetails;
</script>
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("pk_test_51RQYw9Alm0wdSVmSEImNmCNmsFrIpyLQYJvj2vcHLRH0abZNsEwsyzY0FNhuGCg0JFc8An47y5sIAyEbqYEhbWSq00nfTpKPnm");

async function simulatePayment() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const orderData = JSON.parse(localStorage.getItem('orderData')) || {};
  loadTipFromStorage();

  // Transformer le panier pour Stripe en incluant les frais de livraison
  const items = cart.map(item => ({
    price_data: {
      currency: "eur",
      product_data: {
        name: item.product.name
      },
      unit_amount: Math.round(item.product.price * 100)
    },
    quantity: item.quantity
  }));

  // Ajouter les frais de livraison si nécessaire
  if (orderData.delivery) {
    items.push({
      price_data: {
        currency: "eur",
        product_data: {
          name: "Frais de livraison"
        },
        unit_amount: 500 // 5.00€ en centimes
      },
      quantity: 1
    });
  }

  // Ajouter le pourboire si présent
  if (tipValue > 0) {
    items.push({
      price_data: {
        currency: "eur",
        product_data: {
          name: "Pourboire"
        },
        unit_amount: Math.round(tipValue * 100)
      },
      quantity: 1
    });
  }

  try {
    showNotification("Redirection vers la plateforme de paiement en cours...", "info");
    document.querySelector("button").disabled = true;
    const response = await fetch("https://demoresto.onrender.com/create-checkout-session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + getToken()
      },
      body: JSON.stringify({ items, delivery: orderData.delivery })
    });

    const session = await response.json();

    if (session.id) {
      // Avant de rediriger vers Stripe, valider la commande côté backend
      await fetch("https://demoresto.onrender.com/api/validate-order", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + getToken()
        }
      });
      // Vider le panier local
      localStorage.removeItem('cart');
      // Vider le pourboire local
      localStorage.removeItem('tip');
      await stripe.redirectToCheckout({ sessionId: session.id });
    } else {
      showNotification("Erreur Stripe", "error");
    }
  } catch (error) {
    showNotification("Erreur de paiement", "error");
  }
}
</script>
<footer>
  <div class="footer-logo">
    <img src="public/logo.png" alt="Logo Chez Mario">
  </div>
  <div class="footer-infos">
    <p>Chez Mario <span class="sep">|</span> 12 Rue des Oliviers, 66000 Perpignan <span class="sep">|</span> 04 68 12 34 56 <span class="sep">|</span> email: contact@chezmario.fr</p>
  </div>
  <div class="footer-credit">
    <p>Réalisation : GD</p>
  </div>
  <div class="footer-map">
    <a href="https://www.google.com/maps/place/12+Rue+des+Oliviers,+66000+Perpignan" target="_blank" class="map-button">Plan d'accès</a>
  </div>
</footer>
</body>
</html>