<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Paiement</title>
  <script>
    const token = localStorage.getItem('token');
    const cart = JSON.parse(localStorage.getItem('cart'));

    if (!token || !cart || cart.length === 0) {
      // Redirection AVANT chargement de la page
      window.location.href = "panier.html?error=unauthorized";
    }
  </script>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
</head>
<body>
  <div id="notification" class="notification hidden">
  <p id="notification-message"></p>
  <button class="close-btn" onclick="hideNotification()">√ó</button>
</div>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">R√©servation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="user.html" class="btn">Mon Profil</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
      <button id="auth-button"></button>
    </div>
    <div id="user-status"></div>
    <div id="role"></div>
  </nav>
</header>

<section class="order-summary">
  <h2 class="title-payment">R√©sum√© de votre commande</h2>
  <table>
    <thead>
      <tr>
        <th>Produit</th>
        <th>Quantit√©</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="payment-summary-body"></tbody>
  </table>
  <h3 id="payment-total">Total : 0.00‚Ç¨</h3>
</section>

<section class="payment-method">
  <h2>Moyen de paiement</h2>
  <!-- Exemple de paiement fictif -->
  <p>Ce site est une version D√©mo. Aucune transaction r√©elle ne sera effectu√©e. Si vous souhaitez tester, utilisez la carte "4242 4242 4242 4242" avec n'importe quel date dans le futur et n'importe quel CVC. Vous allez etre redirig√© vers Stripe en cliquant ci-dessous.</p>
  <button onclick="simulatePayment()">Payer maintenant</button>
</section>

<script>
function getToken() {
  return localStorage.getItem('token');
}

function loadPaymentDetails() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const tbody = document.getElementById('payment-summary-body');
  const totalElement = document.getElementById('payment-total');
  let total = 0;

  cart.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${item.product.name}</td>
        <td>${item.quantity}</td>
        <td>${(item.product.price * item.quantity).toFixed(2)}‚Ç¨</td>
    `;

    tbody.appendChild(row);
    total += item.product.price * item.quantity;
  });

  totalElement.textContent = `Total : ${total.toFixed(2)}‚Ç¨`;
}

async function clearCartItems() {
  console.log("D√©but clearCartItems");
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  console.log('Contenu du panier:', cart);

  if (cart.length === 0) {
    return Promise.resolve();
  }

  const deletePromises = cart.map(item => {
    console.log('Suppression item avec id:', item.id);
    return fetch(`https://demoresto.onrender.com/api/cart/${item.id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + getToken()
      }
    }).then(res => {
      if (!res.ok) {
        return res.json().then(err => Promise.reject(err));
      }
      return res.json();
    });
  });

  try {
    const results = await Promise.all(deletePromises);
    console.log('Suppression OK', results);
    localStorage.removeItem('cart');
  } catch (error) {
    console.error('Erreur suppression:', error);
    throw error;
  }
}

window.onload = loadPaymentDetails;
</script>
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("pk_test_51RQYw9Alm0wdSVmSEImNmCNmsFrIpyLQYJvj2vcHLRH0abZNsEwsyzY0FNhuGCg0JFc8An47y5sIAyEbqYEhbWSq00nfTpKPnm"); // d√©j√† pr√©sent

async function simulatePayment() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];

  // üí° C‚Äôest ICI qu‚Äôon fait la transformation du panier :
  const items = cart.map(item => ({
    price_data: {
      currency: "eur",
      product_data: {
        name: item.product.name
      },
      unit_amount: Math.round(item.product.price * 100)
    },
    quantity: item.quantity
  }));

  try {
    showNotification("Redirection vers la plateforme de paiement en cours...", "info");
    document.querySelector("button").disabled = true;
    const response = await fetch("https://demoresto.onrender.com/create-checkout-session", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + getToken()  // ‚úÖ Ajout ici
        },
        body: JSON.stringify({ items })
    });

    const session = await response.json();

    if (session.id) {
      await stripe.redirectToCheckout({ sessionId: session.id });
    } else {
      showNotification("Erreur Stripe","error");;
    }
  } catch (error) {
    showNotification("Erreur de paiement","error");;
  }
}

function showNotification(message, type = "success") {
  const notif = document.getElementById('notification');
  const msg = document.getElementById('notification-message');

  if (!notif || !msg) return;

  msg.innerText = message;

  notif.classList.remove('hidden', 'success', 'error', 'info');
  notif.classList.add(type);

  setTimeout(() => {
    hideNotification();
  }, 4000); // Masque automatiquement apr√®s 4 sec
}
</script>
<footer>
  <div class="footer-logo">
    <img src="public/logo.png" alt="Logo Chez Mario">
  </div>
  <div class="footer-infos">
    <p>Chez Mario <span class="sep">|</span> 12 Rue des Oliviers, 66000 Perpignan <span class="sep">|</span> 04 68 12 34 56 <span class="sep">|</span> email: contact@chezmario.fr</p>
  </div>
  <div class="footer-credit">
    <p>R√©alisation : GD</p>
  </div>
  <div class="footer-map">
    <a href="https://www.google.com/maps/place/12+Rue+des+Oliviers,+66000+Perpignan" target="_blank" class="map-button">Plan d‚Äôacc√®s</a>
  </div>
</footer>
</body>
</html>
