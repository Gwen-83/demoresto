<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Votre Panier</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
</head>
<body>
<div id="notification" class="notification hidden">
  <p id="notification-message"></p>
  <button class="close-btn" onclick="hideNotification()">√ó</button>
</div>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">R√©servation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="user.html">Profil</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
      <button id="auth-button"></button>
    </div>
    <div id="user-status"></div>
  </nav>
</header>

<section class="menu-header">
  <h2>Votre Panier</h2>
  <p>Voici les produits de votre choix que vous √™tes sur le point de commander.<br>Attention, le nombre minimal de produit est 1 et le nombre maximal est 30.</p>
</section>

<main id="cart-container">
  <table>
    <thead>
      <tr>
        <th>Produit</th>
        <th>Quantit√©</th>
        <th>Prix</th>
        <th>Total</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="cart-body">
    </tbody>
  </table>
  <p id="empty-cart-message" style="text-align:center; margin-top: 20px; display: none;">
    Votre panier est vide, rendez vous √† l'onglet menu pour commencer vos achat
  </p>

  <!-- Section Livraison -->
  <div class="delivery-section">
    <div class="delivery-checkbox">
      <input type="checkbox" id="delivery-option" onchange="toggleDelivery()">
      <label for="delivery-option">Je souhaite une livraison (+5.00‚Ç¨)</label>
    </div>
    
    <div class="delivery-form" id="delivery-form">
      <div class="delivery-info">
        <strong>üìç Informations de livraison</strong>
        <br>Veuillez remplir tous les champs obligatoires pour organiser votre livraison.
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="delivery-email">Email <span class="required">*</span></label>
          <input type="email" id="delivery-email" required>
        </div>
        <div class="form-group">
          <label for="delivery-phone">T√©l√©phone <span class="required">*</span></label>
          <input type="tel" id="delivery-phone" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="delivery-address">Adresse de livraison <span class="required">*</span></label>
        <textarea id="delivery-address" placeholder="Num√©ro, rue, ville, code postal..." required></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="delivery-date">Date de livraison <span class="required">*</span></label>
          <input type="date" id="delivery-date" required>
        </div>
        <div class="form-group">
          <label for="delivery-time">Heure souhait√©e <span class="required">*</span></label>
          <select id="delivery-time" required>
            <option value="">S√©lectionner une heure</option>
            <option value="11:30">11h30</option>
            <option value="12:00">12h00</option>
            <option value="12:30">12h30</option>
            <option value="13:00">13h00</option>
            <option value="13:30">13h30</option>
            <option value="18:30">18h30</option>
            <option value="19:00">19h00</option>
            <option value="19:30">19h30</option>
            <option value="20:00">20h00</option>
            <option value="20:30">20h30</option>
            <option value="21:00">21h00</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="delivery-instructions">Instructions sp√©ciales (optionnel)</label>
        <textarea id="delivery-instructions" placeholder="√âtage, digicode, instructions particuli√®res..."></textarea>
      </div>
    </div>

    <!-- Section Retrait sur place -->
    <div class="pickup-form" id="pickup-form">
      <div class="delivery-info">
        <strong>üõçÔ∏è Retrait sur place</strong>
        <br>Veuillez choisir une date et une heure pour venir r√©cup√©rer votre commande.
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="pickup-date">Date de retrait <span class="required">*</span></label>
          <input type="date" id="pickup-date" required>
        </div>
        <div class="form-group">
          <label for="pickup-time">Heure de retrait <span class="required">*</span></label>
          <select id="pickup-time" required>
            <option value="">S√©lectionner une heure</option>
            <option value="11:30">11h30</option>
            <option value="12:00">12h00</option>
            <option value="12:30">12h30</option>
            <option value="13:00">13h00</option>
            <option value="13:30">13h30</option>
            <option value="18:30">18h30</option>
            <option value="19:00">19h00</option>
            <option value="19:30">19h30</option>
            <option value="20:00">20h00</option>
            <option value="20:30">20h30</option>
            <option value="21:00">21h00</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <h2 id="cart-total">Total : 0.00‚Ç¨</h2>
</main>

<div class="confirm-button-container">
  <button id="confirm-order-button" class="confirm-button">Confirmer la commande</button>
</div>

<script src="script.js"></script>
<script>
  let deliveryEnabled = false;
  let baseTotal = 0;
  let horairesData = null;

  // Charger les horaires d'ouverture au chargement de la page
  fetch('/api/horaires.json')
    .then(res => res.json())
    .then(data => { horairesData = data; })
    .catch(() => { horairesData = null; });

  function toggleDelivery() {
    const checkbox = document.getElementById('delivery-option');
    const deliveryForm = document.getElementById('delivery-form');
    const pickupForm = document.getElementById('pickup-form');
    deliveryEnabled = checkbox.checked;
    if (deliveryEnabled) {
      deliveryForm.classList.add('active');
      pickupForm.classList.remove('active');
      // D√©finir la date minimale √† aujourd'hui
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('delivery-date').min = today;
    } else {
      deliveryForm.classList.remove('active');
      pickupForm.classList.add('active');
      // D√©finir la date minimale √† aujourd'hui pour le retrait
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('pickup-date').min = today;
      clearDeliveryForm();
    }
    updateCartTotal();
  }

  function clearDeliveryForm() {
    document.getElementById('delivery-email').value = '';
    document.getElementById('delivery-phone').value = '';
    document.getElementById('delivery-address').value = '';
    document.getElementById('delivery-date').value = '';
    document.getElementById('delivery-time').value = '';
    document.getElementById('delivery-instructions').value = '';
    document.getElementById('pickup-date').value = '';
    document.getElementById('pickup-time').value = '';
  }

  function updateCartTotal() {
    const totalElement = document.getElementById('cart-total');
    let total = baseTotal;
    if (deliveryEnabled) {
      total += 5.00;
    }
    totalElement.textContent = `Total : ${total.toFixed(2)}‚Ç¨`;
  }

  function validateDeliveryForm() {
    if (!deliveryEnabled) return true;
    const requiredFields = [
      'delivery-email',
      'delivery-phone', 
      'delivery-address',
      'delivery-date',
      'delivery-time'
    ];
    for (const fieldId of requiredFields) {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        showNotification(`Veuillez remplir le champ ${field.previousElementSibling.textContent.replace(' *', '')}`, "error");
        field.focus();
        return false;
      }
    }
    // Validation email
    const email = document.getElementById('delivery-email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showNotification("Veuillez saisir un email valide", "error");
      return false;
    }
    // Validation t√©l√©phone
    const phone = document.getElementById('delivery-phone').value;
    const phoneRegex = /^[\d\s\-\+\(\)]{10,}$/;
    if (!phoneRegex.test(phone)) {
      showNotification("Veuillez saisir un num√©ro de t√©l√©phone valide", "error");
      return false;
    }
    // Validation horaires d'ouverture
    if (!validateDateTimeInHoraires(document.getElementById('delivery-date').value, document.getElementById('delivery-time').value)) {
      showNotification("La date ou l'heure choisie n'est pas dans les horaires d'ouverture.", "error");
      return false;
    }
    return true;
  }

  function validatePickupForm() {
    if (deliveryEnabled) return true;
    const date = document.getElementById('pickup-date').value;
    const time = document.getElementById('pickup-time').value;
    if (!date || !time) {
      showNotification("Veuillez choisir une date et une heure de retrait.", "error");
      return false;
    }
    if (!validateDateTimeInHoraires(date, time)) {
      showNotification("La date ou l'heure choisie n'est pas dans les horaires d'ouverture.", "error");
      return false;
    }
    return true;
  }

  function getDeliveryInfo() {
    if (!deliveryEnabled) return null;
    return {
      email: document.getElementById('delivery-email').value,
      phone: document.getElementById('delivery-phone').value,
      address: document.getElementById('delivery-address').value,
      date: document.getElementById('delivery-date').value,
      time: document.getElementById('delivery-time').value,
      instructions: document.getElementById('delivery-instructions').value
    };
  }

  function getPickupInfo() {
    if (deliveryEnabled) return null;
    return {
      date: document.getElementById('pickup-date').value,
      time: document.getElementById('pickup-time').value
    };
  }

  // V√©rifie si la date/heure choisie est dans les horaires d'ouverture
  function validateDateTimeInHoraires(dateStr, timeStr) {
    if (!horairesData) return true; // Si pas de donn√©es, ne bloque pas
    const jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
    const d = new Date(dateStr);
    if (isNaN(d)) return false;
    const jour = jours[d.getDay()];
    const horaires = horairesData[jour];
    if (!horaires || horaires === "Ferm√©") return false;
    // Ex: "11h30 - 14h00 / 18h30 - 22h00"
    const plages = horaires.split('/').map(s => s.trim());
    const t = timeStr.replace(':','h');
    for (const plage of plages) {
      const [start, end] = plage.split('-').map(s => s.trim());
      if (compareTime(t, start) >= 0 && compareTime(t, end) <= 0) return true;
    }
    return false;
  }
  // Compare "11h30" et "12h00" => -1 si t1 < t2, 0 si √©gal, 1 si t1 > t2
  function compareTime(t1, t2) {
    const [h1,m1] = t1.split('h').map(Number);
    const [h2,m2] = t2.split('h').map(Number);
    if (h1 !== h2) return h1 - h2;
    return m1 - m2;
  }

  // Modifier le bouton de confirmation pour inclure les informations de livraison ou de retrait
  const confirmButton = document.getElementById("confirm-order-button");
  if (confirmButton) {
    confirmButton.addEventListener("click", () => {
      // Valider le formulaire de livraison ou de retrait
      if (deliveryEnabled) {
        if (!validateDeliveryForm()) return;
      } else {
        if (!validatePickupForm()) return;
      }
      fetch('https://demoresto.onrender.com/api/cart', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => res.json())
      .then(cart => {
        if (!cart || cart.length === 0) {
          showNotification("Votre panier est vide","error");
        } else {
          // Pr√©parer les donn√©es avec les informations de livraison ou de retrait
          const orderData = {
            cart: cart,
            delivery: getDeliveryInfo(),
            pickup: getPickupInfo(),
            total: baseTotal + (deliveryEnabled ? 5.00 : 0)
          };
          // Enregistrer toutes les donn√©es pour la page paiement et user.html
          localStorage.setItem("cart", JSON.stringify(cart));
          localStorage.setItem("orderData", JSON.stringify(orderData));
          // Si livraison activ√©e, envoyer les informations par email
          if (deliveryEnabled) {
            sendDeliveryEmail(getDeliveryInfo());
          }
          window.location.href = "paiement.html";
        }
      })
      .catch(err => {
        console.error("Erreur lors de la r√©cup√©ration du panier :", err);
        showNotification("Impossible de v√©rifier le panier","error");
      });
    });
  }

  function sendDeliveryEmail(deliveryInfo) {
    fetch('https://demoresto.onrender.com/api/send-delivery-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + getToken()
      },
      body: JSON.stringify({
        deliveryInfo: deliveryInfo,
        cartItems: JSON.parse(localStorage.getItem('cart')),
        timestamp: new Date().toLocaleString('fr-FR')
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showNotification("Email de livraison envoy√© avec succ√®s", "success");
      } else {
        showNotification(data.error || "Erreur lors de l'envoi de l'email", "error");
      }
    })
    .catch(err => {
      console.error('Erreur envoi email:', err);
      showNotification("Erreur lors de l'envoi de l'email", "error");
    });
  }

  // Afficher le formulaire de retrait par d√©faut au chargement
  window.addEventListener('DOMContentLoaded', () => {
    if (!document.getElementById('delivery-option').checked) {
      document.getElementById('pickup-form').classList.add('active');
    }
  });
</script>
</body>
</html>