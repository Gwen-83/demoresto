<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion du site - Chez Mario</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
</head>
<body>

<!-- Onglet Commandes - Section corrig√©e -->
<div id="orders-tab" class="tab-content">
  <div class="orders-admin-container">
    <h2>Gestion des commandes</h2>
    
    <!-- Statistiques des commandes -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-number" id="orders-stat-total">0</div>
        <div class="stat-label">Total commandes</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="orders-stat-pending">0</div>
        <div class="stat-label">En attente</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="orders-stat-validated">0</div>
        <div class="stat-label">Valid√©es</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="orders-stat-rejected">0</div>
        <div class="stat-label">Refus√©es</div>
      </div>
    </div>
    
    <div class="orders-section">
      <h3>Commandes en attente</h3>
      <div id="orders-pending-list"></div>
    </div>
    <hr style="margin:2rem 0;">
    <div class="orders-section">
      <h3>Commandes √† venir (valid√©es)</h3>
      <div id="orders-upcoming-list"></div>
    </div>
  </div>
</div>

<!-- Modal de refus de commande -->
<div id="orderRejectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Refuser la commande</h3>
      <span class="close" onclick="closeOrderRejectModal()">&times;</span>
    </div>
    <div class="form-group">
      <label class="form-label">Motif du refus (optionnel) :</label>
      <textarea class="form-control" id="orderRejectReason" rows="4" placeholder="Expliquez la raison du refus..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-modal btn-cancel" onclick="closeOrderRejectModal()">Annuler</button>
      <button class="btn-modal btn-confirm" onclick="confirmOrderReject()">Confirmer le refus</button>
    </div>
  </div>
</div>

<script>
// Variables globales pour les commandes
let orders = [];
let currentOrderId = null;

// Fonction utilitaire pour formater une date depuis YYYY-MM-DD vers DD/MM/YYYY
function formatDateFromISO(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-');
  if (parts.length === 3) {
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return dateStr;
}

// Fonction utilitaire pour formater une heure
function formatTime(timeStr) {
  if (!timeStr) return '';
  // Si l'heure est au format HH:MM:SS, on garde seulement HH:MM
  return timeStr.substring(0, 5);
}

// Charger toutes les commandes (admin)
async function loadOrders() {
  const token = localStorage.getItem('token');
  const pendingList = document.getElementById('orders-pending-list');
  const upcomingList = document.getElementById('orders-upcoming-list');
  
  if (!pendingList || !upcomingList) return;
  
  pendingList.innerHTML = "Chargement...";
  upcomingList.innerHTML = "Chargement...";
  
  try {
    const res = await fetch('/api/admin/orders', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    if (!res.ok) {
      pendingList.innerHTML = "Erreur lors du chargement.";
      upcomingList.innerHTML = "";
      return;
    }
    
    orders = await res.json();
    console.log('Orders loaded:', orders); // Debug
    
    updateOrdersStats();
    
    const today = new Date();
    const todayStr = today.toISOString().slice(0, 10);

    // S√©parer les commandes en attente et √† venir
    const pendingOrders = orders.filter(o => o.status === 'en attente');
    const upcomingOrders = orders.filter(o => {
      const isValidated = o.status === 'validee';
      const hasRequestedDate = o.requested_date && o.requested_date >= todayStr;
      return isValidated && hasRequestedDate;
    });

    console.log('Pending orders:', pendingOrders.length);
    console.log('Upcoming orders:', upcomingOrders.length);

    // Affichage commandes en attente
    if (pendingOrders.length === 0) {
      pendingList.innerHTML = "<div class='no-orders'><p>Aucune commande en attente.</p></div>";
    } else {
      pendingList.innerHTML = pendingOrders.map(order => renderOrderCard(order, true)).join('');
    }

    // Affichage commandes √† venir
    if (upcomingOrders.length === 0) {
      upcomingList.innerHTML = "<div class='no-orders'><p>Aucune commande √† venir.</p></div>";
    } else {
      upcomingList.innerHTML = upcomingOrders.map(order => renderOrderCard(order, false)).join('');
    }
    
  } catch (e) {
    console.error('Error loading orders:', e);
    pendingList.innerHTML = "Erreur r√©seau.";
    upcomingList.innerHTML = "";
  }
}

// Mettre √† jour les statistiques des commandes
function updateOrdersStats() {
  const total = orders.length;
  const pending = orders.filter(o => o.status === 'en attente').length;
  const validated = orders.filter(o => o.status === 'validee').length;
  const rejected = orders.filter(o => o.status === 'refusee').length;
  
  document.getElementById('orders-stat-total').textContent = total;
  document.getElementById('orders-stat-pending').textContent = pending;
  document.getElementById('orders-stat-validated').textContent = validated;
  document.getElementById('orders-stat-rejected').textContent = rejected;
}

// Rendu d'une carte commande am√©lior√©e
function renderOrderCard(order, showActions) {
  console.log('Rendering order:', order); // Debug
  
  // Gestion de la date et heure
  let dateTimeDisplay = '';
  if (order.requested_date && order.requested_time) {
    dateTimeDisplay = `${formatDateFromISO(order.requested_date)} √† ${formatTime(order.requested_time)}`;
  } else if (order.requested_date) {
    dateTimeDisplay = `${formatDateFromISO(order.requested_date)}`;
  } else if (order.created_at) {
    const createdDate = new Date(order.created_at);
    dateTimeDisplay = createdDate.toLocaleDateString('fr-FR') + ' √† ' + createdDate.toLocaleTimeString('fr-FR', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Gestion des produits
  let productsHtml = '';
  let totalAmount = 0;
  
  if (order.items && order.items.length > 0) {
    productsHtml = order.items.map(item => {
      const productName = item.product ? item.product.name : 'Produit supprim√©';
      const productPrice = item.product ? item.product.price : 0;
      const itemTotal = item.total_price || (item.quantity * productPrice);
      totalAmount += itemTotal;
      
      return `
        <div class="order-item">
          <span class="item-quantity">${item.quantity}x</span>
          <span class="item-name">${productName}</span>
          <span class="item-price">${productPrice.toFixed(2)}‚Ç¨</span>
          <span class="item-total">${itemTotal.toFixed(2)}‚Ç¨</span>
        </div>
      `;
    }).join('');
  } else {
    productsHtml = '<div class="order-item"><span>Aucun produit</span></div>';
  }
  
  // Utiliser le total calcul√© par le backend ou notre calcul local
  const finalTotal = order.total || totalAmount;
  
  // Email du client
  const customerEmail = order.user_email || 'Email non disponible';
  
  // Status display
  const statusDisplay = order.status === 'en attente' ? 'En attente' : 
                       order.status === 'validee' ? 'Valid√©e' : 
                       order.status === 'refusee' ? 'Refus√©e' : order.status;
  
  const statusClass = order.status === 'en attente' ? 'pending' : 
                     order.status === 'validee' ? 'validee' : 
                     order.status === 'refusee' ? 'refusee' : '';

  return `
    <div class="order-card ${statusClass}">
      <div class="order-header">
        <div class="order-id">#${order.id}</div>
        <div class="order-status ${statusClass}">${statusDisplay}</div>
      </div>
      
      <div class="order-details">
        <div class="detail-row">
          <span class="detail-label">üìÖ Date/Heure :</span>
          <span class="detail-value">${dateTimeDisplay || 'Non sp√©cifi√©e'}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">üìß Client :</span>
          <span class="detail-value">${customerEmail}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">üõçÔ∏è Produits :</span>
        </div>
        
        <div class="order-products">
          ${productsHtml}
        </div>
        
        <div class="order-total">
          <strong>Total : ${finalTotal.toFixed(2)}‚Ç¨</strong>
        </div>
      </div>
      
      ${showActions ? `
        <div class="order-actions">
          <button class="btn btn-accept" onclick="acceptOrder(${order.id})">‚úì Accepter</button>
          <button class="btn btn-reject" onclick="openOrderRejectModal(${order.id})">‚úó Refuser</button>
        </div>
      ` : ''}
    </div>
  `;
}

// Accepter une commande
async function acceptOrder(orderId) {
  const token = localStorage.getItem('token');
  
  try {
    const res = await fetch(`/api/order/${orderId}/validate`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    if (res.ok) {
      showNotification('Commande accept√©e avec succ√®s', 'success');
      await loadOrders();
    } else {
      const error = await res.json();
      showNotification(error.error || 'Erreur lors de l\'acceptation', 'error');
    }
  } catch (e) {
    console.error('Error accepting order:', e);
    showNotification('Erreur de connexion', 'error');
  }
}

// Modal de refus commande
function openOrderRejectModal(orderId) {
  currentOrderId = orderId;
  document.getElementById('orderRejectModal').style.display = 'block';
  document.getElementById('orderRejectReason').value = '';
}

function closeOrderRejectModal() {
  document.getElementById('orderRejectModal').style.display = 'none';
  currentOrderId = null;
}

async function confirmOrderReject() {
  if (!currentOrderId) return;
  
  const token = localStorage.getItem('token');
  const reason = document.getElementById('orderRejectReason').value;
  
  try {
    const res = await fetch(`/api/order/${currentOrderId}/reject`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason })
    });
    
    if (res.ok) {
      showNotification('Commande refus√©e', 'success');
      closeOrderRejectModal();
      await loadOrders();
    } else {
      const error = await res.json();
      showNotification(error.error || 'Erreur lors du refus', 'error');
    }
  } catch (e) {
    console.error('Error rejecting order:', e);
    showNotification('Erreur de connexion', 'error');
  }
}

// Fonction switchTab mise √† jour
function switchTab(tabName) {
  // Masquer tous les onglets
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // D√©sactiver tous les boutons d'onglet
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Activer l'onglet s√©lectionn√©
  document.getElementById(tabName + '-tab').classList.add('active');
  event.target.classList.add('active');
  
  // Charger les donn√©es sp√©cifiques √† l'onglet
  if (tabName === 'orders') {
    loadOrders();
  }
  // ... autres onglets
}

// Fermer les modals en cliquant √† l'ext√©rieur
window.onclick = function(event) {
  const orderModal = document.getElementById('orderRejectModal');
  if (event.target === orderModal) {
    closeOrderRejectModal();
  }
}

// Fonction pour afficher les notifications (si pas d√©j√† d√©finie)
function showNotification(message, type) {
  // Impl√©mentation simple de notification
  const notification = document.getElementById('notification');
  const notificationMessage = document.getElementById('notification-message');
  
  if (notification && notificationMessage) {
    notificationMessage.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.remove('hidden');
    
    setTimeout(() => {
      notification.classList.add('hidden');
    }, 5000);
  } else {
    // Fallback si pas de syst√®me de notification
    alert(message);
  }
}

function hideNotification() {
  const notification = document.getElementById('notification');
  if (notification) {
    notification.classList.add('hidden');
  }
}

</script>

<style>
/* Styles pour les commandes admin */
.orders-admin-container {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-align: center;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #d4af37;
  margin-bottom: 5px;
}

.stat-label {
  color: #666;
  font-size: 0.9rem;
}

.orders-section {
  margin-bottom: 40px;
}

.orders-section h3 {
  color: #333;
  border-bottom: 2px solid #d4af37;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.order-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-left: 4px solid #d4af37;
}

.order-card.pending {
  border-left-color: #ffa500;
}

.order-card.validee {
  border-left-color: #28a745;
}

.order-card.refusee {
  border-left-color: #dc3545;
}

.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.order-id {
  font-weight: bold;
  font-size: 1.1rem;
  color: #333;
}

.order-status {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: bold;
  text-transform: uppercase;
}

.order-status.pending {
  background-color: #fff3cd;
  color: #856404;
}

.order-status.validee {
  background-color: #d4edda;
  color: #155724;
}

.order-status.refusee {
  background-color: #f8d7da;
  color: #721c24;
}

.order-details {
  margin-bottom: 15px;
}

.detail-row {
  display: flex;
  margin-bottom: 8px;
  align-items: flex-start;
}

.detail-label {
  font-weight: bold;
  margin-right: 10px;
  min-width: 120px;
  color: #555;
}

.detail-value {
  color: #333;
}

.order-products {
  margin: 15px 0;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e9ecef;
}

.order-item {
  display: grid;
  grid-template-columns: 50px 1fr 80px 80px;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid #dee2e6;
  align-items: center;
}

.order-item:last-child {
  border-bottom: none;
}

.item-quantity {
  font-weight: bold;
  color: #666;
}

.item-name {
  color: #333;
}

.item-price, .item-total {
  text-align: right;
  font-weight: bold;
}

.item-total {
  color: #d4af37;
}

.order-total {
  text-align: right;
  font-size: 1.1rem;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid #d4af37;
  color: #d4af37;
}

.order-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.btn-accept {
  background-color: #28a745;
  color: white;
}

.btn-accept:hover {
  background-color: #218838;
}

.btn-reject {
  background-color: #dc3545;
  color: white;
}

.btn-reject:hover {
  background-color: #c82333;
}

.no-orders {
  text-align: center;
  padding: 40px;
  color: #666;
  font-style: italic;
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 15% auto;
  padding: 0;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #eee;
}

.modal-title {
  margin: 0;
  color: #333;
}

.close {
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #999;
}

.close:hover {
  color: #333;
}

.form-group {
  padding: 20px;
}

.form-label {
  display: block;
  margin-bottom: 10px;
  font-weight: bold;
  color: #333;
}

.form-control {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  resize: vertical;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 20px;
  border-top: 1px solid #eee;
}

.btn-modal {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-cancel {
  background-color: #6c757d;
  color: white;
}

.btn-cancel:hover {
  background-color: #5a6268;
}

.btn-confirm {
  background-color: #dc3545;
  color: white;
}

.btn-confirm:hover {
  background-color: #c82333;
}

/* Responsive design */
@media (max-width: 768px) {
  .order-item {
    grid-template-columns: 40px 1fr 60px;
    gap: 8px;
  }
  
  .item-price {
    display: none;
  }
  
  .order-actions {
    flex-direction: column;
  }
  
  .modal-content {
    margin: 10% auto;
    width: 95%;
  }
}
</style>

</body>
</html>