<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Utilisateur - Chez Mario</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    .user-profile-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .profile-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title i {
      color: #b91c1c;
    }

    .reservations-section {
      margin-top: 1rem;
    }

    .reservations-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1rem;
    }

    .reservation-card {
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #f8fafc;
    }

    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .reservation-status {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-validated {
      background: #dcfce7;
      color: #166534;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .reservation-details {
      display: grid;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .detail-row {
      display: flex;
      gap: 0.5rem;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
    }

    .no-reservations {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-style: italic;
    }

    .reservation-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .reservation-tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #64748b;
      font-weight: 500;
    }

    .reservation-tab.active {
      color: #0f172a;
      border-bottom-color: #2563eb;
    }
    
    /* Styles pour l'historique des commandes */
    .orders-section {
      margin-top: 2rem;
    }
    
    .orders-grid {
      display: grid;
      gap: 1.5rem;
      margin-top: 1rem;
    }
    
    .order-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .order-date {
      font-weight: 500;
      color: #374151;
    }
    
    .order-id {
      color: #6b7280;
      font-size: 0.875rem;
    }
    
    .order-status {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .status-completed {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-processing {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-canceled {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .order-content {
      padding: 1rem;
    }
    
    .order-items {
      margin-bottom: 1rem;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .item-details {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .item-quantity {
      background: #f3f4f6;
      color: #4b5563;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .item-name {
      font-weight: 500;
    }
    
    .item-price {
      color: #4b5563;
    }
    
    .order-summary {
      display: flex;
      justify-content: space-between;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
      font-weight: 600;
    }
    
    .order-total-label {
      color: #374151;
    }
    
    .order-total-value {
      color: #b91c1c;
    }
    
    .order-actions {
      margin-top: 1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    
    .order-action-button {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .primary-button {
      background-color: #2563eb;
      color: white;
      border: none;
    }
    
    .primary-button:hover {
      background-color: #1d4ed8;
    }
    
    .secondary-button {
      background-color: white;
      color: #4b5563;
      border: 1px solid #d1d5db;
    }
    
    .secondary-button:hover {
      background-color: #f9fafb;
    }
    
    .orders-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .order-tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #64748b;
      font-weight: 500;
    }
    
    .order-tab.active {
      color: #0f172a;
      border-bottom-color: #b91c1c;
    }
    
    .toggle-details {
      display: flex;
      align-items: center;
      margin-top: 0.5rem;
      cursor: pointer;
      color: #4b5563;
      font-size: 0.875rem;
      user-select: none;
    }
    
    .toggle-details:hover {
      color: #1f2937;
    }
    
    .order-details {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f9fafb;
      border-radius: 4px;
      font-size: 0.875rem;
      display: none;
    }
    
    .order-details.visible {
      display: block;
    }
    
    .detail-section {
      margin-bottom: 0.5rem;
    }
    
    .detail-title {
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.25rem;
    }
    
    .no-orders {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      
      .orders-tabs, .reservation-tabs {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">Réservation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="user.html">Profil</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
      <button id="auth-button"></button>
    </div>
    <div id="user-status"></div>
  </nav>
</header>

<div class="user-profile-container">
  <div id="profile-loading-state" class="loading-message">
    Chargement de votre profil...
  </div>

  <div id="profile-error-display" class="error-message-container" style="display: none;">
  </div>

  <div id="profile-content-section" style="display: none;">
    <div class="profile-section">
      <div class="profile-header-section">
        <div class="user-avatar-circle" id="user-avatar-display">
          U
        </div>
        <h2 class="profile-welcome-title" id="profile-welcome-message">Bienvenue sur votre profil</h2>
      </div>

      <div class="user-information-grid">
        <div class="info-card-item">
          <div class="info-label-text">Nom d'utilisateur</div>
          <div class="info-value-display" id="username-info-display">-</div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Rôle</div>
          <div class="info-value-display" id="user-role-display">-</div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Statut de connexion</div>
          <div class="info-value-display">
            <span class="connection-status-online">● Connecté</span>
          </div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Dernière connexion</div>
          <div class="info-value-display" id="last-login-timestamp">Aujourd'hui</div>
        </div>
      </div>
    </div>

    <!-- Nouvelle section pour l'historique des commandes -->
    <div class="profile-section orders-section">
      <h2 class="section-title">
        <i class="fas fa-history"></i>
        Historique des commandes
      </h2>
      <div class="orders-grid" id="orders-grid">
        <div class="loading-indicator">Chargement de vos commandes...</div>
      </div>
    </div>

    <div class="profile-section reservations-section">
      <h2 class="section-title">
        <i class="fas fa-calendar-alt"></i>
        Mes Réservations
      </h2>
      <div class="reservation-tabs">
        <button class="reservation-tab active" data-tab="upcoming">À venir</button>
        <button class="reservation-tab" data-tab="past">Passées</button>
      </div>
      <div class="reservations-grid" id="reservations-grid">
        <!-- Les réservations seront injectées ici -->
      </div>
    </div>

    <div class="profile-section">
      <div class="user-actions-section">
        <button class="primary-action-button" onclick="navigateToMenu()">Voir le Menu</button>
        <button class="primary-action-button" onclick="navigateToCart()">Mon Panier</button>
        <button class="danger-action-button" onclick="logout()">Se Déconnecter</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-logo">
    <img src="public/logo.png" alt="Logo Chez Mario">
  </div>
  <div class="footer-infos">
    <p>Chez Mario <span class="sep">|</span> 12 Rue des Oliviers, 66000 Perpignan <span class="sep">|</span> 04 68 12 34 56 <span class="sep">|</span> email: contact@chezmario.fr</p>
  </div>
  <div class="footer-credit">
    <p>Réalisation : GD</p>
  </div>
  <div class="footer-map">
    <a href="https://www.google.com/maps/place/12+Rue+des+Oliviers,+66000+Perpignan" target="_blank" class="map-button">Plan d'accès</a>
  </div>
</footer>

<script src="script.js" defer></script>
<script>
// Fonction pour charger les réservations de l'utilisateur
async function loadUserReservations() {
  
  try {
    // Vérifier le token
    const token = localStorage.getItem('token');
    
    if (!token) {
      throw new Error('Non authentifié - aucun token trouvé');
    }

    // Essayer d'abord avec l'URL complète
    const apiUrl = 'https://demoresto.onrender.com/api/reservations';
    
    const response = await fetch(apiUrl, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Erreur ${response.status}: ${errorText}`);
    }

    const reservations = await response.json();

    displayReservations(reservations);
    
  } catch (error) {
    
    // Afficher une erreur plus détaillée
    document.getElementById('reservations-grid').innerHTML = `
      <div class="no-reservations" style="color: red;">
        <strong>Erreur de chargement:</strong><br>
        ${error.message}<br><br>
        <small>Vérifiez la console pour plus de détails</small>
      </div>
    `;
  }
}

// Fonction pour charger l'historique des commandes (simplifiée)
async function loadOrderHistory() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('Non authentifié - aucun token trouvé');
    }
    const ordersGrid = document.getElementById('orders-grid');
    ordersGrid.innerHTML = '<div class="loading-indicator">Chargement des commandes...</div>';

    const response = await fetch('https://demoresto.onrender.com/api/user/order-history', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      const txt = await response.text();
      console.log('Réponse non OK:', txt);
      throw new Error(`Erreur ${response.status}: ${txt}`);
    }

    const orders = await response.json();
    console.log('Commandes récupérées:', orders);

    displayOrderHistory(orders);
  } catch (error) {
    console.error('Erreur lors du chargement des commandes:', error);
    document.getElementById('orders-grid').innerHTML = `
      <div class="no-orders" style="color: red;">
        <strong>Erreur de chargement des commandes:</strong><br>
        ${error.message}
      </div>
    `;
  }
}

// Fonction pour afficher l'historique des commandes (simplifiée)
function displayOrderHistory(orders) {
  const container = document.getElementById('orders-grid');
  console.log('Affichage des commandes:', orders);

  if (!orders || orders.length === 0) {
    container.innerHTML = `
      <div class="no-orders">
        Vous n'avez pas encore passé de commande.
      </div>
    `;
    return;
  }

  container.innerHTML = orders.map(order => {
    // Correction : utiliser order.created_at (UTC ISO) si disponible
    let dateStr = order.date;
    if (order.created_at) {
      // created_at est déjà en UTC ISO (ex: 2024-06-08T11:46:00.000000)
      // On retire les microsecondes si besoin
      let iso = order.created_at.replace(/\.\d+$/, '');
      // Crée un objet Date en UTC
      const d = new Date(iso + 'Z');
      // Affiche uniquement la date (sans l'heure)
      dateStr = d.toLocaleDateString('fr-FR', {
        day: '2-digit', month: '2-digit', year: 'numeric'
      });
    }

    const itemsList = order.items.map(item => `
      <div style="display:flex;justify-content:space-between;padding:2px 0;">
        <span>${item.quantity} x ${item.product_name}</span>
        <span>${item.unit_price.toFixed(2)}€</span>
        <span>Total: ${(item.unit_price * item.quantity).toFixed(2)}€</span>
      </div>
    `).join('');
    return `
      <div class="order-card" style="margin-bottom:1rem;padding:1rem;border:1px solid #eee;border-radius:6px;">
        <div style="font-weight:bold;">Commande #${order.id} - ${dateStr}</div>
        <div style="margin-top:0.5rem;">
          ${itemsList}
        </div>
        <div style="margin-top:0.5rem;font-weight:bold;">Total : ${order.total.toFixed(2)}€</div>
      </div>
    `;
  }).join('');
}

// Fonction pour vérifier les informations utilisateur
async function checkUserInfo() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      console.log('❌ Aucun token trouvé'); 
      return;
    }

    // Décoder le token JWT pour voir les infos (basique, sans vérification de signature)
    const payload = JSON.parse(atob(token.split('.')[1]));
    
    // Vérifier les informations utilisateur via l'API
    const response = await fetch('https://demoresto.onrender.com/api/user/profile', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const userInfo = await response.json();
    } else {
      console.log('❌ Impossible de récupérer le profil utilisateur');
    }
  } catch (error) {
    console.error('Erreur lors de la vérification du profil:', error);
  }
}

// Fonction pour afficher les réservations
function displayReservations(reservations) {
  const container = document.getElementById('reservations-grid');
  const now = new Date();
  
  // Séparer les réservations futures et passées
  const upcoming = [];
  const past = [];
  
  reservations.forEach(reservation => {
    const reservationDate = new Date(reservation.date + 'T' + reservation.heure);
    if (reservationDate > now) {
      upcoming.push(reservation);
    } else {
      past.push(reservation);
    }
  });

  // Fonction pour créer le HTML d'une réservation
  function createReservationHTML(reservation) {
    const statusClasses = {
      'pending': 'status-pending',
      'validee': 'status-validated',
      'refusee': 'status-rejected'
    };

    const statusLabels = {
      'pending': 'En attente',
      'validee': 'Validée',
      'refusee': 'Refusée'
    };

    return `
      <div class="reservation-card">
        <div class="reservation-header">
          <span class="reservation-date">${new Date(reservation.date).toLocaleDateString('fr-FR')} à ${reservation.heure}</span>
          <span class="reservation-status ${statusClasses[reservation.status]}">
            ${statusLabels[reservation.status]}
          </span>
        </div>
        <div class="reservation-details">
          <div class="detail-row">
            <span class="detail-label">Couverts:</span>
            <span>${reservation.couverts}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Téléphone:</span>
            <span>${reservation.telephone}</span>
          </div>
          ${reservation.commentaire ? `
            <div class="detail-row">
              <span class="detail-label">Commentaire:</span>
              <span>${reservation.commentaire}</span>
            </div>
          ` : ''}
          ${reservation.commentaire_admin ? `
            <div class="detail-row">
              <span class="detail-label">Réponse:</span>
              <span>${reservation.commentaire_admin}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Gérer les onglets
  const tabs = document.querySelectorAll('.reservation-tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      if (tab.dataset.tab === 'upcoming') {
        displayReservationsList(upcoming);
      } else {
        displayReservationsList(past);
      }
    });
  });

  // Fonction pour afficher une liste de réservations
  function displayReservationsList(reservations) {
    if (reservations.length === 0) {
      container.innerHTML = `
        <div class="no-reservations">
          Aucune réservation à afficher.
        </div>
      `;
      return;
    }

    container.innerHTML = reservations
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .map(createReservationHTML)
      .join('');
  }

  // Afficher les réservations à venir par défaut
  displayReservationsList(upcoming);
}

async function verifyUserAuthentication() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('Non authentifié');
    }

    const response = await fetch('https://demoresto.onrender.com/api/verify-token', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!response.ok) {
      throw new Error('Token invalide');
    }

    return true;
  } catch (error) {
    console.error('Erreur d\'authentification:', error);
    window.location.href = '/login.html';
    return false;
  }
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', async () => {
  if (document.getElementById('profile-content-section')) {
    try {
      // Vérifier l'authentification de l'utilisateur
      const isUserAuthenticated = await verifyUserAuthentication();
      if (isUserAuthenticated) {
        document.getElementById('profile-loading-state').style.display = 'none';
        document.getElementById('profile-content-section').style.display = 'block';
        displayUserProfileInformation();
        loadUserReservations();
        loadOrderHistory(); // Appel simplifié
      }
    } catch (error) {
      console.error('Erreur lors de l\'initialisation:', error);
      displayErrorMessage("Erreur lors du chargement du profil. Veuillez réessayer.");
    }
  }
});

async function displayUserProfileInformation() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('https://demoresto.onrender.com/api/user/profile', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!response.ok) {
      throw new Error('Erreur lors de la récupération des informations du profil');
    }

    const userInfo = await response.json();
    
    document.getElementById('username-info-display').textContent = userInfo.username;
    document.getElementById('user-role-display').textContent = userInfo.is_admin ? 'Administrateur' : 'Client';
    document.getElementById('user-avatar-display').textContent = userInfo.username.charAt(0).toUpperCase();
    document.getElementById('profile-welcome-message').textContent = `Bienvenue, ${userInfo.username} !`;
  } catch (error) {
    console.error('Erreur:', error);
    displayErrorMessage("Erreur lors du chargement des informations du profil");
  }
}
</script>
</body>
</html>