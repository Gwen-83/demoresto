<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Utilisateur - Chez Mario</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    .reservations-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .reservations-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1rem;
    }

    .reservation-card {
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #f8fafc;
    }

    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .reservation-status {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-validated {
      background: #dcfce7;
      color: #166534;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .reservation-details {
      display: grid;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .detail-row {
      display: flex;
      gap: 0.5rem;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
    }

    .no-reservations {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-style: italic;
    }

    .reservation-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .reservation-tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #64748b;
      font-weight: 500;
    }

    .reservation-tab.active {
      color: #0f172a;
      border-bottom-color: #2563eb;
    }
  </style>
</head>
<body>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">Réservation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
      <button id="auth-button"></button>
    </div>
    <div id="user-status"></div>
  </nav>
</header>

<div class="profile-main-container">
  <div id="profile-loading-state" class="loading-message">
    Chargement de votre profil...
  </div>

  <div id="profile-error-display" class="error-message-container">
  </div>

  <div id="profile-content-section" style="display: none;">
    <div class="user-profile-card">
      <div class="profile-header-section">
        <div class="user-avatar-circle" id="user-avatar-display">
          U
        </div>
        <h2 class="profile-welcome-title" id="profile-welcome-message">Bienvenue sur votre profil</h2>
      </div>

      <div class="user-information-grid">
        <div class="info-card-item">
          <div class="info-label-text">Nom d'utilisateur</div>
          <div class="info-value-display" id="username-info-display">-</div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Rôle</div>
          <div class="info-value-display" id="user-role-display">-</div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Statut de connexion</div>
          <div class="info-value-display">
            <span class="connection-status-online">● Connecté</span>
          </div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Dernière connexion</div>
          <div class="info-value-display" id="last-login-timestamp">Aujourd'hui</div>
        </div>
      </div>

      <div class="reservations-section">
        <h2>Mes Réservations</h2>
        <div class="reservation-tabs">
          <button class="reservation-tab active" data-tab="upcoming">À venir</button>
          <button class="reservation-tab" data-tab="past">Passées</button>
        </div>
        <div class="reservations-grid" id="reservations-grid">
          <!-- Les réservations seront injectées ici -->
        </div>
      </div>

      <div class="user-actions-section">
        <button class="primary-action-button" onclick="navigateToMenu()">Voir le Menu</button>
        <button class="primary-action-button" onclick="navigateToCart()">Mon Panier</button>
        <button class="danger-action-button" onclick="logout()">Se Déconnecter</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-logo">
    <img src="public/logo.png" alt="Logo Chez Mario">
  </div>
  <div class="footer-infos">
    <p>Chez Mario <span class="sep">|</span> 12 Rue des Oliviers, 66000 Perpignan <span class="sep">|</span> 04 68 12 34 56 <span class="sep">|</span> email: contact@chezmario.fr</p>
  </div>
  <div class="footer-credit">
    <p>Réalisation : GD</p>
  </div>
  <div class="footer-map">
    <a href="https://www.google.com/maps/place/12+Rue+des+Oliviers,+66000+Perpignan" target="_blank" class="map-button">Plan d'accès</a>
  </div>
</footer>

<script src="script.js" defer></script>
<script>
// Fonction pour charger les réservations de l'utilisateur
async function loadUserReservations() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('Non authentifié');
    }

    const response = await fetch('/api/reservations', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!response.ok) {
      throw new Error(`Erreur ${response.status}: ${response.statusText}`);
    }

    const reservations = await response.json();
    console.log('Réservations reçues:', reservations); // Debug
    displayReservations(reservations);
  } catch (error) {
    console.error('Erreur lors du chargement des réservations:', error);
    document.getElementById('reservations-grid').innerHTML = `
      <div class="no-reservations">
        Une erreur est survenue lors du chargement de vos réservations: ${error.message}
      </div>
    `;
  }
}

// Fonction utilitaire pour parser une date de réservation
function parseReservationDateTime(dateStr, timeStr) {
  try {
    // Si dateStr est déjà au format YYYY-MM-DD
    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
      return new Date(dateStr + 'T' + timeStr + ':00');
    }
    
    // Si c'est un autre format, essayer de le parser
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) {
      console.warn('Date invalide:', dateStr);
      return null;
    }
    
    // Extraire les composants de temps
    const [hours, minutes] = timeStr.split(':');
    date.setHours(parseInt(hours, 10), parseInt(minutes, 10), 0, 0);
    
    return date;
  } catch (error) {
    console.error('Erreur lors du parsing de la date:', error);
    return null;
  }
}

// Fonction pour afficher les réservations
function displayReservations(reservations) {
  const container = document.getElementById('reservations-grid');
  
  if (!Array.isArray(reservations) || reservations.length === 0) {
    container.innerHTML = `
      <div class="no-reservations">
        Vous n'avez aucune réservation.
      </div>
    `;
    return;
  }

  const now = new Date();
  const upcoming = [];
  const past = [];
  
  // Séparer les réservations futures et passées
  reservations.forEach(reservation => {
    const reservationDateTime = parseReservationDateTime(reservation.date, reservation.heure);
    
    if (!reservationDateTime) {
      console.warn('Réservation avec date invalide ignorée:', reservation);
      return;
    }
    
    if (reservationDateTime > now) {
      upcoming.push({ ...reservation, parsedDateTime: reservationDateTime });
    } else {
      past.push({ ...reservation, parsedDateTime: reservationDateTime });
    }
  });

  // Fonction pour créer le HTML d'une réservation
  function createReservationHTML(reservation) {
    const statusClasses = {
      'pending': 'status-pending',
      'validee': 'status-validated',
      'refusee': 'status-rejected'
    };

    const statusLabels = {
      'pending': 'En attente',
      'validee': 'Validée',
      'refusee': 'Refusée'
    };

    // Formater la date d'affichage
    let displayDate = '';
    if (reservation.parsedDateTime) {
      displayDate = reservation.parsedDateTime.toLocaleDateString('fr-FR');
    } else {
      // Fallback si le parsing a échoué
      displayDate = reservation.date;
    }

    return `
      <div class="reservation-card">
        <div class="reservation-header">
          <span class="reservation-date">${displayDate} à ${reservation.heure}</span>
          <span class="reservation-status ${statusClasses[reservation.status] || 'status-pending'}">
            ${statusLabels[reservation.status] || 'Statut inconnu'}
          </span>
        </div>
        <div class="reservation-details">
          <div class="detail-row">
            <span class="detail-label">Réservation #:</span>
            <span>${reservation.id}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Couverts:</span>
            <span>${reservation.couverts}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Téléphone:</span>
            <span>${reservation.telephone}</span>
          </div>
          ${reservation.commentaire ? `
            <div class="detail-row">
              <span class="detail-label">Commentaire:</span>
              <span>${reservation.commentaire}</span>
            </div>
          ` : ''}
          ${reservation.commentaire_admin ? `
            <div class="detail-row">
              <span class="detail-label">Réponse:</span>
              <span style="color: ${reservation.status === 'refusee' ? '#dc2626' : '#059669'};">
                ${reservation.commentaire_admin}
              </span>
            </div>
          ` : ''}
          ${reservation.created_at ? `
            <div class="detail-row">
              <span class="detail-label">Demandée le:</span>
              <span>${new Date(reservation.created_at).toLocaleDateString('fr-FR')}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Gérer les onglets
  const tabs = document.querySelectorAll('.reservation-tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      if (tab.dataset.tab === 'upcoming') {
        displayReservationsList(upcoming);
      } else {
        displayReservationsList(past);
      }
    });
  });

  // Fonction pour afficher une liste de réservations
  function displayReservationsList(reservationsList) {
    if (reservationsList.length === 0) {
      const tabType = document.querySelector('.reservation-tab.active').dataset.tab;
      const message = tabType === 'upcoming' ? 
        'Aucune réservation à venir.' : 
        'Aucune réservation passée.';
      
      container.innerHTML = `
        <div class="no-reservations">
          ${message}
        </div>
      `;
      return;
    }

    // Trier par date (plus récent en premier pour upcoming, plus ancien en premier pour past)
    const sortedReservations = [...reservationsList].sort((a, b) => {
      const dateA = a.parsedDateTime || new Date(a.date);
      const dateB = b.parsedDateTime || new Date(b.date);
      
      // Pour les réservations à venir, on veut les plus proches en premier
      // Pour les réservations passées, on veut les plus récentes en premier
      const isUpcoming = document.querySelector('.reservation-tab.active').dataset.tab === 'upcoming';
      return isUpcoming ? dateA - dateB : dateB - dateA;
    });

    container.innerHTML = sortedReservations
      .map(createReservationHTML)
      .join('');
  }

  // Afficher les réservations à venir par défaut
  displayReservationsList(upcoming);
  
  // Mettre à jour les compteurs dans les onglets
  updateTabCounts(upcoming.length, past.length);
}

// Fonction pour mettre à jour les compteurs dans les onglets
function updateTabCounts(upcomingCount, pastCount) {
  const upcomingTab = document.querySelector('[data-tab="upcoming"]');
  const pastTab = document.querySelector('[data-tab="past"]');
  
  if (upcomingTab) {
    upcomingTab.textContent = `À venir (${upcomingCount})`;
  }
  if (pastTab) {
    pastTab.textContent = `Passées (${pastCount})`;
  }
}

// Charger les réservations au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
  // Vérifier que nous sommes sur la page profile
  if (document.getElementById('profile-content-section')) {
    // Attendre que le profil soit chargé avant de charger les réservations
    setTimeout(() => {
      loadUserReservations();
    }, 500);
  }
});

// Fonction pour rafraîchir les réservations (utile après une action)
function refreshReservations() {
  loadUserReservations();
}
</script>
</body>
</html>