<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Utilisateur - Chez Mario</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    .reservations-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .reservations-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1rem;
    }

    .reservation-card {
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #f8fafc;
    }

    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .reservation-status {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-validated {
      background: #dcfce7;
      color: #166534;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .reservation-details {
      display: grid;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .detail-row {
      display: flex;
      gap: 0.5rem;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
    }

    .no-reservations {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-style: italic;
    }

    .reservation-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .reservation-tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #64748b;
      font-weight: 500;
    }

    .reservation-tab.active {
      color: #0f172a;
      border-bottom-color: #2563eb;
    }
  </style>
</head>
<body>
<header>
  <h1>Chez Mario</h1>
  <button class="menu-toggle" aria-label="Ouvrir le menu">&#9776;</button>
  <nav>
    <div class="nav-left">
      <a href="index.html">Accueil</a>
      <a href="menu.html">Menu</a>
      <a href="reservation.html">R√©servation</a>
      <a href="contact.html">Contact</a>
      <a href="panier.html">Voir le panier</a>
      <a href="user.html">Profil</a>
      <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
      <button id="auth-button"></button>
    </div>
    <div id="user-status"></div>
  </nav>
</header>

<div class="profile-main-container">
  <div id="profile-loading-state" class="loading-message">
    Chargement de votre profil...
  </div>

  <div id="profile-error-display" class="error-message-container">
  </div>

  <div id="profile-content-section" style="display: none;">
    <div class="user-profile-card">
      <div class="profile-header-section">
        <div class="user-avatar-circle" id="user-avatar-display">
          U
        </div>
        <h2 class="profile-welcome-title" id="profile-welcome-message">Bienvenue sur votre profil</h2>
      </div>

      <div class="user-information-grid">
        <div class="info-card-item">
          <div class="info-label-text">Nom d'utilisateur</div>
          <div class="info-value-display" id="username-info-display">-</div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">R√¥le</div>
          <div class="info-value-display" id="user-role-display">-</div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Statut de connexion</div>
          <div class="info-value-display">
            <span class="connection-status-online">‚óè Connect√©</span>
          </div>
        </div>

        <div class="info-card-item">
          <div class="info-label-text">Derni√®re connexion</div>
          <div class="info-value-display" id="last-login-timestamp">Aujourd'hui</div>
        </div>
      </div>

      <div class="reservations-section">
        <h2>Mes R√©servations</h2>
        <div class="reservation-tabs">
          <button class="reservation-tab active" data-tab="upcoming">√Ä venir</button>
          <button class="reservation-tab" data-tab="past">Pass√©es</button>
        </div>
        <div class="reservations-grid" id="reservations-grid">
          <!-- Les r√©servations seront inject√©es ici -->
        </div>
      </div>

      <div class="user-actions-section">
        <button class="primary-action-button" onclick="navigateToMenu()">Voir le Menu</button>
        <button class="primary-action-button" onclick="navigateToCart()">Mon Panier</button>
        <button class="danger-action-button" onclick="logout()">Se D√©connecter</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-logo">
    <img src="public/logo.png" alt="Logo Chez Mario">
  </div>
  <div class="footer-infos">
    <p>Chez Mario <span class="sep">|</span> 12 Rue des Oliviers, 66000 Perpignan <span class="sep">|</span> 04 68 12 34 56 <span class="sep">|</span> email: contact@chezmario.fr</p>
  </div>
  <div class="footer-credit">
    <p>R√©alisation : GD</p>
  </div>
  <div class="footer-map">
    <a href="https://www.google.com/maps/place/12+Rue+des+Oliviers,+66000+Perpignan" target="_blank" class="map-button">Plan d'acc√®s</a>
  </div>
</footer>

<script src="script.js" defer></script>
<script>
// Fonction pour charger les r√©servations de l'utilisateur
async function loadUserReservations() {
  console.log('üîç D√©but du chargement des r√©servations...');
  
  try {
    // V√©rifier le token
    const token = localStorage.getItem('token');
    console.log('üîë Token pr√©sent:', !!token);
    
    if (!token) {
      throw new Error('Non authentifi√© - aucun token trouv√©');
    }

    // Essayer d'abord avec l'URL compl√®te
    const apiUrl = 'https://demoresto.onrender.com/api/reservations';
    console.log('üåê Appel API vers:', apiUrl);
    
    const response = await fetch(apiUrl, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    console.log('üì° R√©ponse API - Status:', response.status);
    console.log('üì° R√©ponse API - OK:', response.ok);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Erreur API:', errorText);
      throw new Error(`Erreur ${response.status}: ${errorText}`);
    }

    const reservations = await response.json();
    console.log('üìã R√©servations re√ßues:', reservations);
    console.log('üìä Nombre de r√©servations:', reservations.length);

    displayReservations(reservations);
    
  } catch (error) {
    console.error('üí• Erreur compl√®te:', error);
    
    // Afficher une erreur plus d√©taill√©e
    document.getElementById('reservations-grid').innerHTML = `
      <div class="no-reservations" style="color: red;">
        <strong>Erreur de chargement:</strong><br>
        ${error.message}<br><br>
        <small>V√©rifiez la console pour plus de d√©tails</small>
      </div>
    `;
  }
}

// Fonction pour v√©rifier les informations utilisateur
async function checkUserInfo() {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      console.log('‚ùå Aucun token trouv√©');
      return;
    }

    // D√©coder le token JWT pour voir les infos (basique, sans v√©rification de signature)
    const payload = JSON.parse(atob(token.split('.')[1]));
    console.log('üë§ Infos utilisateur dans le token:', payload);
    
    // V√©rifier les informations utilisateur via l'API
    const response = await fetch('https://demoresto.onrender.com/api/user/profile', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const userInfo = await response.json();
      console.log('üë§ Profil utilisateur:', userInfo);
    } else {
      console.log('‚ùå Impossible de r√©cup√©rer le profil utilisateur');
    }
  } catch (error) {
    console.error('Erreur lors de la v√©rification du profil:', error);
  }
}

// Ajouter cette fonction au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('profile-content-section')) {
    console.log('üöÄ Initialisation du profil utilisateur...');
    checkUserInfo(); // V√©rifier d'abord les infos utilisateur
    loadUserReservations(); // Puis charger les r√©servations
  }
});

// Fonction de test pour cr√©er une r√©servation de test
async function testCreateReservation() {
  const token = localStorage.getItem('token');
  const testReservation = {
    email: 'test@example.com', // Remplacez par votre email
    telephone: '0123456789',
    couverts: 2,
    date: '2025-06-15',
    heure: '19:00',
    commentaire: 'Test de r√©servation'
  };

  try {
    const response = await fetch('https://demoresto.onrender.com/api/reservation', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(testReservation)
    });

    const result = await response.json();
    console.log('Test r√©servation:', result);
  } catch (error) {
    console.error('Erreur test r√©servation:', error);
  }
}

// Fonction pour afficher les r√©servations
function displayReservations(reservations) {
  const container = document.getElementById('reservations-grid');
  const now = new Date();
  
  // S√©parer les r√©servations futures et pass√©es
  const upcoming = [];
  const past = [];
  
  reservations.forEach(reservation => {
    const reservationDate = new Date(reservation.date + 'T' + reservation.heure);
    if (reservationDate > now) {
      upcoming.push(reservation);
    } else {
      past.push(reservation);
    }
  });

  // Fonction pour cr√©er le HTML d'une r√©servation
  function createReservationHTML(reservation) {
    const statusClasses = {
      'pending': 'status-pending',
      'validee': 'status-validated',
      'refusee': 'status-rejected'
    };

    const statusLabels = {
      'pending': 'En attente',
      'validee': 'Valid√©e',
      'refusee': 'Refus√©e'
    };

    return `
      <div class="reservation-card">
        <div class="reservation-header">
          <span class="reservation-date">${new Date(reservation.date).toLocaleDateString('fr-FR')} √† ${reservation.heure}</span>
          <span class="reservation-status ${statusClasses[reservation.status]}">
            ${statusLabels[reservation.status]}
          </span>
        </div>
        <div class="reservation-details">
          <div class="detail-row">
            <span class="detail-label">Couverts:</span>
            <span>${reservation.couverts}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">T√©l√©phone:</span>
            <span>${reservation.telephone}</span>
          </div>
          ${reservation.commentaire ? `
            <div class="detail-row">
              <span class="detail-label">Commentaire:</span>
              <span>${reservation.commentaire}</span>
            </div>
          ` : ''}
          ${reservation.commentaire_admin ? `
            <div class="detail-row">
              <span class="detail-label">R√©ponse:</span>
              <span>${reservation.commentaire_admin}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  // G√©rer les onglets
  const tabs = document.querySelectorAll('.reservation-tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      if (tab.dataset.tab === 'upcoming') {
        displayReservationsList(upcoming);
      } else {
        displayReservationsList(past);
      }
    });
  });

  // Fonction pour afficher une liste de r√©servations
  function displayReservationsList(reservations) {
    if (reservations.length === 0) {
      container.innerHTML = `
        <div class="no-reservations">
          Aucune r√©servation √† afficher.
        </div>
      `;
      return;
    }

    container.innerHTML = reservations
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .map(createReservationHTML)
      .join('');
  }

  // Afficher les r√©servations √† venir par d√©faut
  displayReservationsList(upcoming);
}

// Charger les r√©servations au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('profile-content-section')) {
    loadUserReservations();
  }
});
</script>
</body>
</html>